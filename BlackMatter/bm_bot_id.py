import base64
import struct
import md4
import bm_hash


MACHINE_GUID = '873ba7f3-0986-40d0-97df-a1e48ced854f'


def get_victim_id(machine_guid):

    h = bm_hash.get_wide_str_hash(MACHINE_GUID, 0xFFFFFFFF)
    h = bm_hash.get_wide_str_hash(MACHINE_GUID, h)
    h = bm_hash.get_wide_str_hash(MACHINE_GUID, h)

    s = b''
    for i in range(4):
        s += bytes([h & 0xFF])
        h >>= 8
    s += s[::-1]

    victim_id = bytearray(base64.encodebytes(s).strip())
    for i in range(len(victim_id)):
        if (victim_id[i] == 0x2B):
            victim_id[i] = 0x78
        elif (victim_id[i] == 0x2F):
            victim_id[i] = 0x69
        elif (victim_id[i] == 0x3D):
            victim_id[i] = 0x7A

    return victim_id.decode()


def get_bot_id(machine_guid, bigendian=False):

    h1 = bm_hash.get_wide_str_hash(MACHINE_GUID, 0)

    h2 = md4.hash(h1.to_bytes(4, byteorder='little'))

    fmt = '>' if bigendian else '<'
    fmt += '4L'

    n = struct.unpack(fmt, h2)

    return ('%.8x%.8x%.8x%.8x' % tuple(n))


victim_id = get_victim_id(MACHINE_GUID)
print('victim_id: \"%s\"' % victim_id)

bot_id = get_bot_id(MACHINE_GUID, True)
print('bot_id:    \"%s\"' % bot_id)

mutex_name = get_bot_id(MACHINE_GUID, False)
print('mutex:     \"Global\\%s\"' % mutex_name)
