import sys
import io
import zlib
import rc4


CFG_POS = 0x11000

KEY_LEN = 32


if len(sys.argv) != 2:
    print('Usage: '+ sys.argv[0] + ' file_name')
    sys.exit(0)

file_name = sys.argv[1]

with io.open(file_name, 'rb') as f:

    f.seek(CFG_POS)

    key = f.read(KEY_LEN)

    crc = int.from_bytes(f.read(4), byteorder='little', signed=False)
    print('cfg data crc32: %08X' % crc)

    cfg_data_size = int.from_bytes(f.read(4), byteorder='little', signed=False)
    print('cfg data size:  %d' % cfg_data_size)

    enc_cfg_data = f.read(cfg_data_size)

crc_2 = zlib.crc32(enc_cfg_data)
if (crc != crc_2):
    raise Exception('Invalid cfg data checksum.')

cfg_data = rc4.rc4(enc_cfg_data, key)

with io.open(file_name + '.cfg', 'wb') as f:
    f.write(cfg_data)
