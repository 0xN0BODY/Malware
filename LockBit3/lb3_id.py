import base64
import struct
import hashlib


def get_guid_str(rsa_pub_key):
    """Get GUID string from RSA public key data"""
    h = hashlib.md5()
    h.update(rsa_pub_key)
    x = struct.unpack('<L2H8B', h.digest())
    return '{%08X-%04X-%04X-%02X%02X-%02X%02X%02X%02X%02X%02X}' % x


def get_victim_id(guid):
    """Get Victim ID"""

    h = hashlib.md5()
    h.update(guid.encode('UTF-16LE'))
    victim_id = base64.encodebytes(h.digest())

    victim_id = bytearray(victim_id[:9])
    for i in range(len(victim_id)):
        if (victim_id[i] == 0x2B):    # '+'
            victim_id[i] = 0x78       # 'x'
        elif (victim_id[i] == 0x2F):  # '/'
            victim_id[i] = 0x69       # 'i'
        elif (victim_id[i] == 0x3D):  # '='
            victim_id[i] = 0x7A       # 'z'

    return victim_id.decode()


if __name__ == '__main__':
    import sys
    import io

    with io.open('rsa_pub_key.bin', 'rb') as f:
        rsa_pub_key = f.read()

    guid = get_guid_str(rsa_pub_key)

    victim_id = get_victim_id(guid)
    print('victim ID: \"%s\"' % victim_id)
